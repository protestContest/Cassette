import List
import Math
import Canvas
import System
import Map

let width = 800,
    height = 480,
    canvas = Canvas.new(width, height)

def update-pt(pt) do
  def constrain-x(pt) do
    if pt.x < 0 or pt.x > width do
      Map.put(pt, :dir, Math.Pi - pt.dir)
    else
      pt
    end
  end

  def constrain-y(pt) do
    if pt.y < 0 or pt.y > height do
      Map.put(pt, :dir, 2 * Math.Pi - pt.dir)
    else
      pt
    end
  end

  def update-pos(pt) do
    let dx = pt.speed * Math.cos(pt.dir),
        dy = pt.speed * Math.sin(pt.dir)
    Map.put(Map.put(pt, :x, pt.x + dx), :y, pt.y + dy)
  end

  constrain-y(constrain-x(update-pos(pt)))
end

def random-pt {
  x: Math.rand-int(0, width),
  y: Math.rand-int(0, height),
  dir: 2 * Math.Pi * Math.random(),
  speed: 5
}

def loop(a, b, count) do
  if count == 0 do
    canvas.clear(Canvas.white)
    loop(a, b, 1000)
  else
    canvas.line({a.x, a.y}, {b.x, b.y})
    loop(update-pt(a), update-pt(b), count - 1)
  end
end

loop(random-pt(), random-pt(), 1000)
