import Window, IO, Math, List, Value

def should_quit(event)
  event.what == :keyDown and
  ((event.message & 0xFF == $q and Window.modifier?(event, :cmd)) or
   (event.message >> 8 == 0x35))

def loop(window) do
  let event = Window.next_event()
  in do
    if event.what, IO.inspect(event) else nil
    Window.update(window)
    if should_quit(event), nil
    else loop(window)
  end
end

let
  width = 400
  height = 300
  window = Window.open("Test", width, height)
  white = [0, 0xFF, 0xFF, 0xFF]
  black = [0, 0, 0, 0]
in do
  let pixels =
    List.map(List.range(0, height), \y ->
      List.map(List.range(0, width), \x ->
        let bit = x % 8
        in if ((x >> bit) + y) & 1, black else white))
    img = Value.format(pixels)
  in do
    Window.blit(img, width, height, 0, 0, window)
    loop(window)
  end
end
